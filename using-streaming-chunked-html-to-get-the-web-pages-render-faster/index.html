<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> Using Streaming Chunked HTML to Get The Web pages render faster · Catalin T.</title><meta name="description" content="When it comes to your users’ perception of speed, nothing causes more harm than a blank white page and a busy browser icon showing no progress. Sending the first part of the response before it’s finished can have a big impact on the perceived speed of your app.

Below are some ideas to get this done, code examples are written in node.js but they can be used in any other programming language.
BigPipeA few years ago, Facebook introduced a new technique it started using on its homepage ca"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="short icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="stylesheet" href="http://fonts.useso.com/css?family=Source+Sans+Pro:400,600" type="text/css"></head><body><header><a href="/" class="logo-link"><img src="/img/package.svg"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">博客</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li><li class="nav-list-item"><a href="https://github.com/xxxxx" target="_blank" class="nav-list-link">GITHUB</a></li></ul></header><section class="container"><div class="post"><article class="post-block"><h2 class="post-title"><a href="/using-streaming-chunked-html-to-get-the-web-pages-render-faster/" class="post-title-link">Using Streaming Chunked HTML to Get The Web pages render faster</a></h2><div class="post-meta"><div class="post-time">Apr 25, 2014</div></div><div class="post-content"><p><span style="color: #666666;">When it comes to your users’ perception of speed, nothing causes more harm than a blank white page and a busy browser icon showing no progress. Sending the first part of the response before it’s finished can have a big impact on the perceived speed of your app.</span></p>
<a id="more"></a>
<p>Below are some ideas to get this done, code examples are written in node.js but they can be used in any other programming language.</p>
<h2 id="BigPipe"><strong>BigPipe</strong></h2><p>A few years ago, Facebook introduced a new technique it started using on its homepage called <a href="https://www.facebook.com/notes/facebook-engineering/bigpipe-pipelining-web-pages-for-high-performance/389414033919" target="_blank" rel="external">BigPipe</a>. It combines the benefits of <a href="https://developers.google.com/speed/docs/best-practices/request" target="_blank" rel="external">making fewer HTTP calls</a>with being <a href="https://developers.google.com/speed/articles/browser-paint-events" target="_blank" rel="external">quick to the first paint</a>. The benefits can be substantial, but BigPipe uses some unconventional approaches to dividing up CSS and markup that could be quite a departure from the common frameworks and architecture you’re probably using to build your apps. Unless you’ve achieved Facebook’s scale, the tradeoffs might not be worth it.</p>
<h2 id="Half-measures_with_benefits"><strong>Half-measures with benefits</strong></h2><p>You can still get a lot of mileage out of a few simple tweaks that won’t require many changes to your standard setup. When it comes to your users’ perception of speed, nothing causes more harm than a blank white page and a busy browser icon showing no progress. Sending the first part of the response before it’s finished can have a big impact on the perceived speed of your app.</p>
<p>The technique is pretty simple: we’ll be using a feature of HTTP 1.1 called<a href="http://en.wikipedia.org/wiki/Chunked_transfer_encoding" target="_blank" rel="external">Chunked transfer encoding</a>. With a standard Express.js response, you normally use <code>res.send</code> or <code>res.render</code>. These handy shortcuts write best-guess headers and send of the response with a single command.<span id="more-15534" style="font-weight: inherit; font-style: inherit;"></span></p>
<p>The downside is that it doesn’t send anything before that. You might be holding up the whole page while you wait for one little section that’s pulling from the Twitter API.</p>
<p>Instead, we’ll break things up and write a few more lines of code. Let’s start with the HTML <code>head</code>, our CSS and JS tags, and the opening tag of the <code>body</code> element:</p>
<div id="crayon-5359fefbc4ad9827338244" class="crayon-syntax crayon-theme-familiar crayon-font-monaco crayon-os-pc print-yes crayon-wrapped" style="color: #666666;" data-settings=" minimize scroll-mouseover wrap"><br><div class="crayon-plain-wrap" style="font-weight: inherit; font-style: inherit;"></div><br><div class="crayon-main" style="font-weight: inherit; font-style: inherit;"><br><table class="crayon-table" style="font-weight: inherit; font-style: inherit;"><br><tbody style="font-weight: inherit; font-style: inherit;"><br><tr class="crayon-row" style="font-weight: inherit; font-style: inherit;"><br><td class="crayon-nums " style="font-weight: inherit; font-style: inherit; color: #afafaf !important;" data-settings="hide"><br><div class="crayon-nums-content" style="font-weight: inherit; font-style: inherit;"><br><div class="crayon-num" style="font-weight: inherit !important; font-style: inherit;" data-line="crayon-5359fefbc4ad9827338244-1">1</div><br><div class="crayon-num crayon-striped-num" style="font-weight: inherit !important; font-style: inherit;" data-line="crayon-5359fefbc4ad9827338244-2">2</div><br><div class="crayon-num" style="font-weight: inherit !important; font-style: inherit;" data-line="crayon-5359fefbc4ad9827338244-3">3</div><br><div class="crayon-num crayon-striped-num" style="font-weight: inherit !important; font-style: inherit;" data-line="crayon-5359fefbc4ad9827338244-4">4</div><br><div class="crayon-num" style="font-weight: inherit !important; font-style: inherit;" data-line="crayon-5359fefbc4ad9827338244-5">5</div><br></div></td><br><td class="crayon-code" style="font-weight: inherit; font-style: inherit;"><br><div class="crayon-pre" style="font-weight: inherit; font-style: inherit;"><br><div id="crayon-5359fefbc4ad9827338244-1" class="crayon-line" style="font-weight: inherit !important; font-style: inherit;"><span class="crayon-v" style="font-weight: inherit !important; font-style: inherit; color: #002d7a !important;">app</span><span class="crayon-sy" style="font-weight: inherit !important; font-style: inherit; color: #333333 !important;">.</span><span class="crayon-e" style="font-weight: inherit !important; font-style: inherit; color: #004ed0 !important;">get</span><span class="crayon-sy" style="font-weight: inherit !important; font-style: inherit; color: #333333 !important;">(</span><span class="crayon-s" style="font-weight: inherit !important; font-style: inherit; color: #008000 !important;">‘/test’</span><span class="crayon-sy" style="font-weight: inherit !important; font-style: inherit; color: #333333 !important;">,</span><span class="crayon-t" style="font-weight: inherit !important; font-style: inherit; color: #800080 !important;">function</span><span class="crayon-sy" style="font-weight: inherit !important; font-style: inherit; color: #333333 !important;">(</span><span class="crayon-i" style="font-weight: inherit !important; font-style: inherit;">req</span><span class="crayon-sy" style="font-weight: inherit !important; font-style: inherit; color: #333333 !important;">,</span><span class="crayon-i" style="font-weight: inherit !important; font-style: inherit;">res</span><span class="crayon-sy" style="font-weight: inherit !important; font-style: inherit; color: #333333 !important;">)</span><span class="crayon-sy" style="font-weight: inherit !important; font-style: inherit; color: #333333 !important;">{</span></div><br><div id="crayon-5359fefbc4ad9827338244-2" class="crayon-line crayon-striped-line" style="font-weight: inherit !important; font-style: inherit;"><span class="crayon-h" style="font-weight: inherit !important; font-style: inherit; color: #006fe0 !important;">  </span><span class="crayon-v" style="font-weight: inherit !important; font-style: inherit; color: #002d7a !important;">res</span><span class="crayon-sy" style="font-weight: inherit !important; font-style: inherit; color: #333333 !important;">.</span><span class="crayon-e" style="font-weight: inherit !important; font-style: inherit; color: #004ed0 !important;">write</span><span class="crayon-sy" style="font-weight: inherit !important; font-style: inherit; color: #333333 !important;">(</span><span class="crayon-s" style="font-weight: inherit !important; font-style: inherit; color: #008000 !important;">‘&lt;html&gt;&lt;head&gt;’</span><span class="crayon-sy" style="font-weight: inherit !important; font-style: inherit; color: #333333 !important;">)</span><span class="crayon-sy" style="font-weight: inherit !important; font-style: inherit; color: #333333 !important;">;</span></div><br><div id="crayon-5359fefbc4ad9827338244-3" class="crayon-line" style="font-weight: inherit !important; font-style: inherit;"><span class="crayon-h" style="font-weight: inherit !important; font-style: inherit; color: #006fe0 !important;">  </span><span class="crayon-c" style="font-weight: inherit !important; font-style: inherit; color: #ff8000 !important;">// res.write(… css and js tags)</span></div><br><div id="crayon-5359fefbc4ad9827338244-4" class="crayon-line crayon-striped-line" style="font-weight: inherit !important; font-style: inherit;"><span class="crayon-h" style="font-weight: inherit !important; font-style: inherit; color: #006fe0 !important;">  </span><span class="crayon-v" style="font-weight: inherit !important; font-style: inherit; color: #002d7a !important;">res</span><span class="crayon-sy" style="font-weight: inherit !important; font-style: inherit; color: #333333 !important;">.</span><span class="crayon-e" style="font-weight: inherit !important; font-style: inherit; color: #004ed0 !important;">write</span><span class="crayon-sy" style="font-weight: inherit !important; font-style: inherit; color: #333333 !important;">(</span><span class="crayon-s" style="font-weight: inherit !important; font-style: inherit; color: #008000 !important;">‘&lt;body&gt;’</span><span class="crayon-sy" style="font-weight: inherit !important; font-style: inherit; color: #333333 !important;">)</span><span class="crayon-sy" style="font-weight: inherit !important; font-style: inherit; color: #333333 !important;">;</span></div><br><div id="crayon-5359fefbc4ad9827338244-5" class="crayon-line" style="font-weight: inherit !important; font-style: inherit;"><span class="crayon-sy" style="font-weight: inherit !important; font-style: inherit; color: #333333 !important;">}</span><span class="crayon-sy" style="font-weight: inherit !important; font-style: inherit; color: #333333 !important;">)</span><span class="crayon-sy" style="font-weight: inherit !important; font-style: inherit; color: #333333 !important;">;</span></div><br></div></td><br></tr><br></tbody><br></table><br></div><br></div>

<p>Express automatically sets the HTTP ‘Transfer-Encoding’ header to ‘chunked.’ It then sends the HTML that we’ve created here. Once the browser sees the JS and CSS tags in that <code>head</code> element, it can start downloading those assets while your app is finishing the body of its response.</p>
<p>After we’ve fetched and rendered the necessary bits for the rest of our page (database calls, external APIs, and so forth), we write those out, and then close the <code>body</code> and HTML tags, and finish the response by using <code>res.end</code>.</p>
<div id="crayon-5359fefbc4ae9564201401" class="crayon-syntax crayon-theme-familiar crayon-font-monaco crayon-os-pc print-yes crayon-wrapped" style="color: #666666;" data-settings=" minimize scroll-mouseover wrap"><br><div class="crayon-plain-wrap" style="font-weight: inherit; font-style: inherit;"></div><br><div class="crayon-main" style="font-weight: inherit; font-style: inherit;"><br><table class="crayon-table" style="font-weight: inherit; font-style: inherit;"><br><tbody style="font-weight: inherit; font-style: inherit;"><br><tr class="crayon-row" style="font-weight: inherit; font-style: inherit;"><br><td class="crayon-nums " style="font-weight: inherit; font-style: inherit; color: #afafaf !important;" data-settings="hide"><br><div class="crayon-nums-content" style="font-weight: inherit; font-style: inherit;"><br><div class="crayon-num" style="font-weight: inherit !important; font-style: inherit;" data-line="crayon-5359fefbc4ae9564201401-1">1</div><br><div class="crayon-num crayon-striped-num" style="font-weight: inherit !important; font-style: inherit;" data-line="crayon-5359fefbc4ae9564201401-2">2</div><br><div class="crayon-num" style="font-weight: inherit !important; font-style: inherit;" data-line="crayon-5359fefbc4ae9564201401-3">3</div><br><div class="crayon-num crayon-striped-num" style="font-weight: inherit !important; font-style: inherit;" data-line="crayon-5359fefbc4ae9564201401-4">4</div><br><div class="crayon-num" style="font-weight: inherit !important; font-style: inherit;" data-line="crayon-5359fefbc4ae9564201401-5">5</div><br><div class="crayon-num crayon-striped-num" style="font-weight: inherit !important; font-style: inherit;" data-line="crayon-5359fefbc4ae9564201401-6">6</div><br><div class="crayon-num" style="font-weight: inherit !important; font-style: inherit;" data-line="crayon-5359fefbc4ae9564201401-7">7</div><br><div class="crayon-num crayon-striped-num" style="font-weight: inherit !important; font-style: inherit;" data-line="crayon-5359fefbc4ae9564201401-8">8</div><br></div></td><br><td class="crayon-code" style="font-weight: inherit; font-style: inherit;"><br><div class="crayon-pre" style="font-weight: inherit; font-style: inherit;"><br><div id="crayon-5359fefbc4ae9564201401-1" class="crayon-line" style="font-weight: inherit !important; font-style: inherit;"><span class="crayon-v" style="font-weight: inherit !important; font-style: inherit; color: #002d7a !important;">app</span><span class="crayon-sy" style="font-weight: inherit !important; font-style: inherit; color: #333333 !important;">.</span><span class="crayon-e" style="font-weight: inherit !important; font-style: inherit; color: #004ed0 !important;">get</span><span class="crayon-sy" style="font-weight: inherit !important; font-style: inherit; color: #333333 !important;">(</span><span class="crayon-s" style="font-weight: inherit !important; font-style: inherit; color: #008000 !important;">‘/test’</span><span class="crayon-sy" style="font-weight: inherit !important; font-style: inherit; color: #333333 !important;">,</span><span class="crayon-t" style="font-weight: inherit !important; font-style: inherit; color: #800080 !important;">function</span><span class="crayon-sy" style="font-weight: inherit !important; font-style: inherit; color: #333333 !important;">(</span><span class="crayon-i" style="font-weight: inherit !important; font-style: inherit;">req</span><span class="crayon-sy" style="font-weight: inherit !important; font-style: inherit; color: #333333 !important;">,</span><span class="crayon-i" style="font-weight: inherit !important; font-style: inherit;">res</span><span class="crayon-sy" style="font-weight: inherit !important; font-style: inherit; color: #333333 !important;">)</span><span class="crayon-sy" style="font-weight: inherit !important; font-style: inherit; color: #333333 !important;">{</span></div><br><div id="crayon-5359fefbc4ae9564201401-2" class="crayon-line crayon-striped-line" style="font-weight: inherit !important; font-style: inherit;"><span class="crayon-h" style="font-weight: inherit !important; font-style: inherit; color: #006fe0 !important;">  </span><span class="crayon-v" style="font-weight: inherit !important; font-style: inherit; color: #002d7a !important;">res</span><span class="crayon-sy" style="font-weight: inherit !important; font-style: inherit; color: #333333 !important;">.</span><span class="crayon-e" style="font-weight: inherit !important; font-style: inherit; color: #004ed0 !important;">write</span><span class="crayon-sy" style="font-weight: inherit !important; font-style: inherit; color: #333333 !important;">(</span><span class="crayon-s" style="font-weight: inherit !important; font-style: inherit; color: #008000 !important;">‘&lt;html&gt;&lt;head&gt;’</span><span class="crayon-sy" style="font-weight: inherit !important; font-style: inherit; color: #333333 !important;">)</span><span class="crayon-sy" style="font-weight: inherit !important; font-style: inherit; color: #333333 !important;">;</span></div><br><div id="crayon-5359fefbc4ae9564201401-3" class="crayon-line" style="font-weight: inherit !important; font-style: inherit;"><span class="crayon-h" style="font-weight: inherit !important; font-style: inherit; color: #006fe0 !important;">  </span><span class="crayon-c" style="font-weight: inherit !important; font-style: inherit; color: #ff8000 !important;">// res.write(… css and js tags)</span></div><br><div id="crayon-5359fefbc4ae9564201401-4" class="crayon-line crayon-striped-line" style="font-weight: inherit !important; font-style: inherit;"><span class="crayon-h" style="font-weight: inherit !important; font-style: inherit; color: #006fe0 !important;">  </span><span class="crayon-v" style="font-weight: inherit !important; font-style: inherit; color: #002d7a !important;">res</span><span class="crayon-sy" style="font-weight: inherit !important; font-style: inherit; color: #333333 !important;">.</span><span class="crayon-e" style="font-weight: inherit !important; font-style: inherit; color: #004ed0 !important;">write</span><span class="crayon-sy" style="font-weight: inherit !important; font-style: inherit; color: #333333 !important;">(</span><span class="crayon-s" style="font-weight: inherit !important; font-style: inherit; color: #008000 !important;">‘&lt;body&gt;’</span><span class="crayon-sy" style="font-weight: inherit !important; font-style: inherit; color: #333333 !important;">)</span><span class="crayon-sy" style="font-weight: inherit !important; font-style: inherit; color: #333333 !important;">;</span></div><br><div id="crayon-5359fefbc4ae9564201401-5" class="crayon-line" style="font-weight: inherit !important; font-style: inherit;"><span class="crayon-h" style="font-weight: inherit !important; font-style: inherit; color: #006fe0 !important;">  </span><span class="crayon-c" style="font-weight: inherit !important; font-style: inherit; color: #ff8000 !important;">// fetch data and write main body of page </span></div><br><div id="crayon-5359fefbc4ae9564201401-6" class="crayon-line crayon-striped-line" style="font-weight: inherit !important; font-style: inherit;"><span class="crayon-h" style="font-weight: inherit !important; font-style: inherit; color: #006fe0 !important;">  </span><span class="crayon-c" style="font-weight: inherit !important; font-style: inherit; color: #ff8000 !important;">// with more res.write(‘…’) calls</span></div><br><div id="crayon-5359fefbc4ae9564201401-7" class="crayon-line" style="font-weight: inherit !important; font-style: inherit;"><span class="crayon-h" style="font-weight: inherit !important; font-style: inherit; color: #006fe0 !important;">  </span><span class="crayon-v" style="font-weight: inherit !important; font-style: inherit; color: #002d7a !important;">res</span><span class="crayon-sy" style="font-weight: inherit !important; font-style: inherit; color: #333333 !important;">.</span><span class="crayon-st" style="font-weight: inherit !important; font-style: inherit; color: #800080 !important;">end</span><span class="crayon-sy" style="font-weight: inherit !important; font-style: inherit; color: #333333 !important;">(</span><span class="crayon-s" style="font-weight: inherit !important; font-style: inherit; color: #008000 !important;">‘&lt;/body&gt;&lt;/html&gt;’</span><span class="crayon-sy" style="font-weight: inherit !important; font-style: inherit; color: #333333 !important;">)</span><span class="crayon-sy" style="font-weight: inherit !important; font-style: inherit; color: #333333 !important;">;</span></div><br><div id="crayon-5359fefbc4ae9564201401-8" class="crayon-line crayon-striped-line" style="font-weight: inherit !important; font-style: inherit;"><span class="crayon-sy" style="font-weight: inherit !important; font-style: inherit; color: #333333 !important;">}</span><span class="crayon-sy" style="font-weight: inherit !important; font-style: inherit; color: #333333 !important;">)</span><span class="crayon-sy" style="font-weight: inherit !important; font-style: inherit; color: #333333 !important;">;</span></div><br></div></td><br></tr><br></tbody><br></table><br></div><br></div>

<h2 id="Streams"><strong>Streams</strong></h2><p>Another option is to use Node Streams and <code>pipe</code> to the response. This requires a readable stream. For example, using the ever popular <a href="https://github.com/mikeal/request" target="_blank" rel="external">Request module</a>, you can<code>pipe</code> the incoming response from an external source straight to a <code>response</code> that your app sends to the browser, like this:</p>
<div id="crayon-5359fefbc4af4245975857" class="crayon-syntax crayon-theme-familiar crayon-font-monaco crayon-os-pc print-yes crayon-wrapped" style="color: #666666;" data-settings=" minimize scroll-mouseover wrap"><br><div class="crayon-plain-wrap" style="font-weight: inherit; font-style: inherit;"></div><br><div class="crayon-main" style="font-weight: inherit; font-style: inherit;"><br><table class="crayon-table" style="font-weight: inherit; font-style: inherit;"><br><tbody style="font-weight: inherit; font-style: inherit;"><br><tr class="crayon-row" style="font-weight: inherit; font-style: inherit;"><br><td class="crayon-nums " style="font-weight: inherit; font-style: inherit; color: #afafaf !important;" data-settings="hide"><br><div class="crayon-nums-content" style="font-weight: inherit; font-style: inherit;"><br><div class="crayon-num" style="font-weight: inherit !important; font-style: inherit;" data-line="crayon-5359fefbc4af4245975857-1">1</div><br><div class="crayon-num crayon-striped-num" style="font-weight: inherit !important; font-style: inherit;" data-line="crayon-5359fefbc4af4245975857-2">2</div><br><div class="crayon-num" style="font-weight: inherit !important; font-style: inherit;" data-line="crayon-5359fefbc4af4245975857-3">3</div><br></div></td><br><td class="crayon-code" style="font-weight: inherit; font-style: inherit;"><br><div class="crayon-pre" style="font-weight: inherit; font-style: inherit;"><br><div id="crayon-5359fefbc4af4245975857-1" class="crayon-line" style="font-weight: inherit !important; font-style: inherit;"><span class="crayon-v" style="font-weight: inherit !important; font-style: inherit; color: #002d7a !important;">app</span><span class="crayon-sy" style="font-weight: inherit !important; font-style: inherit; color: #333333 !important;">.</span><span class="crayon-e" style="font-weight: inherit !important; font-style: inherit; color: #004ed0 !important;">get</span><span class="crayon-sy" style="font-weight: inherit !important; font-style: inherit; color: #333333 !important;">(</span><span class="crayon-s" style="font-weight: inherit !important; font-style: inherit; color: #008000 !important;">‘/test’</span><span class="crayon-sy" style="font-weight: inherit !important; font-style: inherit; color: #333333 !important;">,</span><span class="crayon-t" style="font-weight: inherit !important; font-style: inherit; color: #800080 !important;">function</span><span class="crayon-sy" style="font-weight: inherit !important; font-style: inherit; color: #333333 !important;">(</span><span class="crayon-i" style="font-weight: inherit !important; font-style: inherit;">req</span><span class="crayon-sy" style="font-weight: inherit !important; font-style: inherit; color: #333333 !important;">,</span><span class="crayon-i" style="font-weight: inherit !important; font-style: inherit;">res</span><span class="crayon-sy" style="font-weight: inherit !important; font-style: inherit; color: #333333 !important;">)</span><span class="crayon-sy" style="font-weight: inherit !important; font-style: inherit; color: #333333 !important;">{</span></div><br><div id="crayon-5359fefbc4af4245975857-2" class="crayon-line crayon-striped-line" style="font-weight: inherit !important; font-style: inherit;"><span class="crayon-h" style="font-weight: inherit !important; font-style: inherit; color: #006fe0 !important;">  </span><span class="crayon-v" style="font-weight: inherit !important; font-style: inherit; color: #002d7a !important;">req</span><span class="crayon-sy" style="font-weight: inherit !important; font-style: inherit; color: #333333 !important;">.</span><span class="crayon-e" style="font-weight: inherit !important; font-style: inherit; color: #004ed0 !important;">pipe</span><span class="crayon-sy" style="font-weight: inherit !important; font-style: inherit; color: #333333 !important;">(</span><span class="crayon-e" style="font-weight: inherit !important; font-style: inherit; color: #004ed0 !important;">request</span><span class="crayon-sy" style="font-weight: inherit !important; font-style: inherit; color: #333333 !important;">(</span><span class="crayon-s" style="font-weight: inherit !important; font-style: inherit; color: #008000 !important;">‘<a href="http://mysite.com/doodle.png" target="_blank" rel="external">http://mysite.com/doodle.png</a>‘</span><span class="crayon-sy" style="font-weight: inherit !important; font-style: inherit; color: #333333 !important;">)</span><span class="crayon-sy" style="font-weight: inherit !important; font-style: inherit; color: #333333 !important;">)</span><span class="crayon-sy" style="font-weight: inherit !important; font-style: inherit; color: #333333 !important;">.</span><span class="crayon-e" style="font-weight: inherit !important; font-style: inherit; color: #004ed0 !important;">pipe</span><span class="crayon-sy" style="font-weight: inherit !important; font-style: inherit; color: #333333 !important;">(</span><span class="crayon-i" style="font-weight: inherit !important; font-style: inherit;">resp</span><span class="crayon-sy" style="font-weight: inherit !important; font-style: inherit; color: #333333 !important;">)</span><span class="crayon-sy" style="font-weight: inherit !important; font-style: inherit; color: #333333 !important;">;</span></div><br><div id="crayon-5359fefbc4af4245975857-3" class="crayon-line" style="font-weight: inherit !important; font-style: inherit;"><span class="crayon-sy" style="font-weight: inherit !important; font-style: inherit; color: #333333 !important;">}</span><span class="crayon-sy" style="font-weight: inherit !important; font-style: inherit; color: #333333 !important;">)</span><span class="crayon-sy" style="font-weight: inherit !important; font-style: inherit; color: #333333 !important;">;</span></div><br></div></td><br></tr><br></tbody><br></table><br></div><br></div>

<h2 id="Beyond_Express"><strong>Beyond Express</strong></h2><p>I recently wrote an <a href="http://strongloop.com/strongblog/node-js-express-introduction-koa-js-zone/" target="_blank" rel="external">intro to Koa</a>. Unlike the <code>res.*</code> syntax of Express, Koa generally uses <code>this.body = &#39;HTML HERE&#39;</code>. There’s an example in the Koa repo that shows one way to <a href="https://github.com/koajs/examples/tree/master/stream-view" target="_blank" rel="external">stream an HTML page</a>. If you’re not ready to live on the bleeding edge of node v0.11.x, take a look at <a href="https://github.com/then/then-jade" target="_blank" rel="external">then-jade</a>; you’ll get some of the cool syntax of ES6 generators and the benefits of streaming chunks of HTML, all with the cozy v0.10.x environment and the <a href="http://strongloop.com/strongblog/using-node-js-for-static-sites-jade/" target="_blank" rel="external">awesomeness of Jade</a>.</p>
<h2 id="No_chunks_please"><strong>No chunks please</strong></h2><p>In modern browsers, the <a href="https://developer.mozilla.org/en-US/docs/Web/API/XMLHttpRequest" target="_blank" rel="external">XHR object’s</a> <code>readyState</code> can have a value of<code>&#39;LOADING&#39;</code> (3). That allows them to handle the chunked encoding that we’re sending. However, if you’re still stuck supporting IE8 (or lower) you can use a clever addition of socket.io, nicely packaged up as <a href="https://www.npmjs.org/package/streamable" target="_blank" rel="external">Streamable</a>. If that seems like too much of a hack, you can use Express’ content-negotiation syntax to send the response the “old fashioned” way when the request is via XHR:</p>
<div id="crayon-5359fefbc4aff527149138" class="crayon-syntax crayon-theme-familiar crayon-font-monaco crayon-os-pc print-yes crayon-wrapped" style="color: #666666;" data-settings=" minimize scroll-mouseover wrap"><br><div class="crayon-plain-wrap" style="font-weight: inherit; font-style: inherit;"></div><br><div class="crayon-main" style="font-weight: inherit; font-style: inherit;"><br><table class="crayon-table" style="font-weight: inherit; font-style: inherit;"><br><tbody style="font-weight: inherit; font-style: inherit;"><br><tr class="crayon-row" style="font-weight: inherit; font-style: inherit;"><br><td class="crayon-nums " style="font-weight: inherit; font-style: inherit; color: #afafaf !important;" data-settings="hide"><br><div class="crayon-nums-content" style="font-weight: inherit; font-style: inherit;"><br><div class="crayon-num" style="font-weight: inherit !important; font-style: inherit;" data-line="crayon-5359fefbc4aff527149138-1">1</div><br><div class="crayon-num crayon-striped-num" style="font-weight: inherit !important; font-style: inherit;" data-line="crayon-5359fefbc4aff527149138-2">2</div><br><div class="crayon-num" style="font-weight: inherit !important; font-style: inherit;" data-line="crayon-5359fefbc4aff527149138-3">3</div><br><div class="crayon-num crayon-striped-num" style="font-weight: inherit !important; font-style: inherit;" data-line="crayon-5359fefbc4aff527149138-4">4</div><br><div class="crayon-num" style="font-weight: inherit !important; font-style: inherit;" data-line="crayon-5359fefbc4aff527149138-5">5</div><br><div class="crayon-num crayon-striped-num" style="font-weight: inherit !important; font-style: inherit;" data-line="crayon-5359fefbc4aff527149138-6">6</div><br><div class="crayon-num" style="font-weight: inherit !important; font-style: inherit;" data-line="crayon-5359fefbc4aff527149138-7">7</div><br><div class="crayon-num crayon-striped-num" style="font-weight: inherit !important; font-style: inherit;" data-line="crayon-5359fefbc4aff527149138-8">8</div><br><div class="crayon-num" style="font-weight: inherit !important; font-style: inherit;" data-line="crayon-5359fefbc4aff527149138-9">9</div><br><div class="crayon-num crayon-striped-num" style="font-weight: inherit !important; font-style: inherit;" data-line="crayon-5359fefbc4aff527149138-10">10</div><br><div class="crayon-num" style="font-weight: inherit !important; font-style: inherit;" data-line="crayon-5359fefbc4aff527149138-11">11</div><br><div class="crayon-num crayon-striped-num" style="font-weight: inherit !important; font-style: inherit;" data-line="crayon-5359fefbc4aff527149138-12">12</div><br><div class="crayon-num" style="font-weight: inherit !important; font-style: inherit;" data-line="crayon-5359fefbc4aff527149138-13">13</div><br></div></td><br><td class="crayon-code" style="font-weight: inherit; font-style: inherit;"><br><div class="crayon-pre" style="font-weight: inherit; font-style: inherit;"><br><div id="crayon-5359fefbc4aff527149138-1" class="crayon-line" style="font-weight: inherit !important; font-style: inherit;"><span class="crayon-v" style="font-weight: inherit !important; font-style: inherit; color: #002d7a !important;">app</span><span class="crayon-sy" style="font-weight: inherit !important; font-style: inherit; color: #333333 !important;">.</span><span class="crayon-e" style="font-weight: inherit !important; font-style: inherit; color: #004ed0 !important;">get</span><span class="crayon-sy" style="font-weight: inherit !important; font-style: inherit; color: #333333 !important;">(</span><span class="crayon-s" style="font-weight: inherit !important; font-style: inherit; color: #008000 !important;">‘/test’</span><span class="crayon-sy" style="font-weight: inherit !important; font-style: inherit; color: #333333 !important;">,</span><span class="crayon-t" style="font-weight: inherit !important; font-style: inherit; color: #800080 !important;">function</span><span class="crayon-sy" style="font-weight: inherit !important; font-style: inherit; color: #333333 !important;">(</span><span class="crayon-i" style="font-weight: inherit !important; font-style: inherit;">req</span><span class="crayon-sy" style="font-weight: inherit !important; font-style: inherit; color: #333333 !important;">,</span><span class="crayon-i" style="font-weight: inherit !important; font-style: inherit;">res</span><span class="crayon-sy" style="font-weight: inherit !important; font-style: inherit; color: #333333 !important;">)</span><span class="crayon-sy" style="font-weight: inherit !important; font-style: inherit; color: #333333 !important;">{</span></div><br><div id="crayon-5359fefbc4aff527149138-2" class="crayon-line crayon-striped-line" style="font-weight: inherit !important; font-style: inherit;"><span class="crayon-h" style="font-weight: inherit !important; font-style: inherit; color: #006fe0 !important;">  </span><span class="crayon-st" style="font-weight: inherit !important; font-style: inherit; color: #800080 !important;">if</span><span class="crayon-sy" style="font-weight: inherit !important; font-style: inherit; color: #333333 !important;">(</span><span class="crayon-v" style="font-weight: inherit !important; font-style: inherit; color: #002d7a !important;">req</span><span class="crayon-sy" style="font-weight: inherit !important; font-style: inherit; color: #333333 !important;">.</span><span class="crayon-i" style="font-weight: inherit !important; font-style: inherit;">xhr</span><span class="crayon-sy" style="font-weight: inherit !important; font-style: inherit; color: #333333 !important;">)</span><span class="crayon-sy" style="font-weight: inherit !important; font-style: inherit; color: #333333 !important;">{</span></div><br><div id="crayon-5359fefbc4aff527149138-3" class="crayon-line" style="font-weight: inherit !important; font-style: inherit;"><span class="crayon-h" style="font-weight: inherit !important; font-style: inherit; color: #006fe0 !important;">    </span><span class="crayon-c" style="font-weight: inherit !important; font-style: inherit; color: #ff8000 !important;">// fetch data, pass to template</span></div><br><div id="crayon-5359fefbc4aff527149138-4" class="crayon-line crayon-striped-line" style="font-weight: inherit !important; font-style: inherit;"><span class="crayon-h" style="font-weight: inherit !important; font-style: inherit; color: #006fe0 !important;">    </span><span class="crayon-c" style="font-weight: inherit !important; font-style: inherit; color: #ff8000 !important;">// response is sent in one command</span></div><br><div id="crayon-5359fefbc4aff527149138-5" class="crayon-line" style="font-weight: inherit !important; font-style: inherit;"><span class="crayon-h" style="font-weight: inherit !important; font-style: inherit; color: #006fe0 !important;">    </span><span class="crayon-v" style="font-weight: inherit !important; font-style: inherit; color: #002d7a !important;">res</span><span class="crayon-sy" style="font-weight: inherit !important; font-style: inherit; color: #333333 !important;">.</span><span class="crayon-e" style="font-weight: inherit !important; font-style: inherit; color: #004ed0 !important;">render</span><span class="crayon-sy" style="font-weight: inherit !important; font-style: inherit; color: #333333 !important;">(</span><span class="crayon-i" style="font-weight: inherit !important; font-style: inherit;">data</span><span class="crayon-sy" style="font-weight: inherit !important; font-style: inherit; color: #333333 !important;">)</span><span class="crayon-sy" style="font-weight: inherit !important; font-style: inherit; color: #333333 !important;">;</span></div><br><div id="crayon-5359fefbc4aff527149138-6" class="crayon-line crayon-striped-line" style="font-weight: inherit !important; font-style: inherit;"><span class="crayon-h" style="font-weight: inherit !important; font-style: inherit; color: #006fe0 !important;">  </span><span class="crayon-sy" style="font-weight: inherit !important; font-style: inherit; color: #333333 !important;">}</span><span class="crayon-st" style="font-weight: inherit !important; font-style: inherit; color: #800080 !important;">else</span><span class="crayon-sy" style="font-weight: inherit !important; font-style: inherit; color: #333333 !important;">{</span></div><br><div id="crayon-5359fefbc4aff527149138-7" class="crayon-line" style="font-weight: inherit !important; font-style: inherit;"><span class="crayon-h" style="font-weight: inherit !important; font-style: inherit; color: #006fe0 !important;">    </span><span class="crayon-v" style="font-weight: inherit !important; font-style: inherit; color: #002d7a !important;">res</span><span class="crayon-sy" style="font-weight: inherit !important; font-style: inherit; color: #333333 !important;">.</span><span class="crayon-e" style="font-weight: inherit !important; font-style: inherit; color: #004ed0 !important;">write</span><span class="crayon-sy" style="font-weight: inherit !important; font-style: inherit; color: #333333 !important;">(</span><span class="crayon-s" style="font-weight: inherit !important; font-style: inherit; color: #008000 !important;">‘&lt;html&gt;&lt;head&gt;’</span><span class="crayon-sy" style="font-weight: inherit !important; font-style: inherit; color: #333333 !important;">)</span><span class="crayon-sy" style="font-weight: inherit !important; font-style: inherit; color: #333333 !important;">;</span></div><br><div id="crayon-5359fefbc4aff527149138-8" class="crayon-line crayon-striped-line" style="font-weight: inherit !important; font-style: inherit;"><span class="crayon-h" style="font-weight: inherit !important; font-style: inherit; color: #006fe0 !important;">    </span><span class="crayon-c" style="font-weight: inherit !important; font-style: inherit; color: #ff8000 !important;">// res.write(… css and js tags)</span></div><br><div id="crayon-5359fefbc4aff527149138-9" class="crayon-line" style="font-weight: inherit !important; font-style: inherit;"><span class="crayon-h" style="font-weight: inherit !important; font-style: inherit; color: #006fe0 !important;">    </span><span class="crayon-v" style="font-weight: inherit !important; font-style: inherit; color: #002d7a !important;">res</span><span class="crayon-sy" style="font-weight: inherit !important; font-style: inherit; color: #333333 !important;">.</span><span class="crayon-e" style="font-weight: inherit !important; font-style: inherit; color: #004ed0 !important;">write</span><span class="crayon-sy" style="font-weight: inherit !important; font-style: inherit; color: #333333 !important;">(</span><span class="crayon-s" style="font-weight: inherit !important; font-style: inherit; color: #008000 !important;">‘&lt;body&gt;’</span><span class="crayon-sy" style="font-weight: inherit !important; font-style: inherit; color: #333333 !important;">)</span><span class="crayon-sy" style="font-weight: inherit !important; font-style: inherit; color: #333333 !important;">;</span></div><br><div id="crayon-5359fefbc4aff527149138-10" class="crayon-line crayon-striped-line" style="font-weight: inherit !important; font-style: inherit;"><span class="crayon-h" style="font-weight: inherit !important; font-style: inherit; color: #006fe0 !important;">    </span><span class="crayon-c" style="font-weight: inherit !important; font-style: inherit; color: #ff8000 !important;">// fetch data and write main body of page </span></div><br><div id="crayon-5359fefbc4aff527149138-11" class="crayon-line" style="font-weight: inherit !important; font-style: inherit;"><span class="crayon-h" style="font-weight: inherit !important; font-style: inherit; color: #006fe0 !important;">    </span><span class="crayon-c" style="font-weight: inherit !important; font-style: inherit; color: #ff8000 !important;">// with more res.write(‘…’) calls</span></div><br><div id="crayon-5359fefbc4aff527149138-12" class="crayon-line crayon-striped-line" style="font-weight: inherit !important; font-style: inherit;"><span class="crayon-h" style="font-weight: inherit !important; font-style: inherit; color: #006fe0 !important;">    </span><span class="crayon-v" style="font-weight: inherit !important; font-style: inherit; color: #002d7a !important;">res</span><span class="crayon-sy" style="font-weight: inherit !important; font-style: inherit; color: #333333 !important;">.</span><span class="crayon-st" style="font-weight: inherit !important; font-style: inherit; color: #800080 !important;">end</span><span class="crayon-sy" style="font-weight: inherit !important; font-style: inherit; color: #333333 !important;">(</span><span class="crayon-s" style="font-weight: inherit !important; font-style: inherit; color: #008000 !important;">‘&lt;/body&gt;&lt;/html&gt;’</span><span class="crayon-sy" style="font-weight: inherit !important; font-style: inherit; color: #333333 !important;">)</span><span class="crayon-sy" style="font-weight: inherit !important; font-style: inherit; color: #333333 !important;">;</span></div><br><div id="crayon-5359fefbc4aff527149138-13" class="crayon-line" style="font-weight: inherit !important; font-style: inherit;"><span class="crayon-sy" style="font-weight: inherit !important; font-style: inherit; color: #333333 !important;">}</span><span class="crayon-sy" style="font-weight: inherit !important; font-style: inherit; color: #333333 !important;">)</span><span class="crayon-sy" style="font-weight: inherit !important; font-style: inherit; color: #333333 !important;">;</span></div><br></div></td><br></tr><br></tbody><br></table><br></div><br></div>

<p>To go the extra mile, you might try some client-side detection for support of<code>readyState === 3</code>, and pass an extra parameter in your XHR call to let the server know it can send a chunked response. But some browsers that support chunked encoding in XHR still won’t let you access the data that’s received until the request is finished, which eliminates the primary benefit.</p>
<h2 id="Yak_Shaving"><strong>Yak Shaving</strong></h2><p>There’s an obvious tradeoff here; we’re essentially stripping out the shortcuts and common lingo that Express gives us and reverting back to core Node response syntax and/or using obscure libraries. If your page is really simple and quick to render, the extra syntax might not be worth it.</p>
<p>Source: <a href="http://strongloop.com/strongblog/streaming-chunked-html-node-js-data/" target="_blank" rel="external">http://strongloop.com/</a></p>
</div></article></div></section><footer><div class="paginator"><a href="/ls-in-windows-command-prompt/" class="prev">上一篇</a><a href="/nginx-automatic-domain-configuration-script-for-cpanel/" class="next">下一篇</a></div></footer><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-XXXXXXX-X",'auto');ga('send','pageview');</script><script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "//hm.baidu.com/hm.js?xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script><script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script></body></html>